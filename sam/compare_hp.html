<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate AI Benchmark: RepViT vs MobileSAM</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 20px; background: #f4f4f9; color: #333; }
        .container { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        h1 { margin: 10px 0; font-size: 1.8rem; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 25px; }
        
        /* Image Preview Area */
        .image-container { position: relative; height: 200px; background: #eee; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #previewImg { max-height: 100%; max-width: 100%; border-radius: 8px; transition: opacity 0.3s; }
        .overlay { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; }

        /* Buttons */
        button { width: 100%; padding: 16px; font-size: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button#loadBtn { background: #007bff; color: white; }
        button#runBtn { background: #28a745; color: white; display: none; }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* Status & Logs */
        #status { margin: 15px 0; font-weight: 600; min-height: 20px; color: #444; }
        
        /* Results Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; display: none; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #666; font-size: 0.85em; text-transform: uppercase; }
        .highlight { font-weight: bold; color: #007bff; }
        
        /* Winner/Loser Styles */
        .winner { background-color: #d4edda; color: #155724; }
        .loser { background-color: #f8d7da; color: #721c24; }
        
        #final-score { margin-top: 20px; font-size: 1.1em; font-weight: bold; padding: 15px; background: #e9ecef; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚öîÔ∏è Ultimate AI Benchmark ‚öîÔ∏è</h1>
    <div class="subtitle">RepViT-SAM vs MobileSAM (Avg of 6 Images)</div>
    
    <div class="image-container">
        <img id="previewImg" src="app/assets/picture1.jpg" alt="Preview">
        <div class="overlay" id="imgCounter">Image 1/6</div>
    </div>
    
    <div id="status">Waiting to load models...</div>
    
    <div style="background:#eee; height:6px; border-radius:3px; margin: 15px 0; overflow:hidden;">
        <div id="progressBar" style="width:0%; height:100%; background:#28a745; transition: width 0.3s;"></div>
    </div>

    <button id="loadBtn" onclick="init()">üì• Load Models & Prepare</button>
    <button id="runBtn" onclick="startBenchmark()">üöÄ Run 6-Image Benchmark</button>
    
    <table id="resultTable">
        <thead>
            <tr>
                <th>Model</th>
                <th>Avg Encoder</th>
                <th>Avg Decoder</th>
                <th>Avg Total</th>
            </tr>
        </thead>
        <tbody>
            <tr id="row-repvit">
                <td style="text-align:left;">RepViT-SAM</td>
                <td id="rep-enc">-</td>
                <td id="rep-dec">-</td>
                <td id="rep-total" class="highlight">-</td>
            </tr>
            <tr id="row-mobile">
                <td style="text-align:left;">MobileSAM</td>
                <td id="mob-enc">-</td>
                <td id="mob-dec">-</td>
                <td id="mob-total" class="highlight">-</td>
            </tr>
        </tbody>
    </table>

    <div id="final-score"></div>
</div>

<script>
    // --- CONFIGURATION ---
    const IMAGES = [
        'app/assets/picture1.jpg',
        'app/assets/picture2.jpg',
        'app/assets/picture3.jpg',
        'app/assets/picture4.jpg',
        'app/assets/picture5.jpg',
        'app/assets/picture6.jpg'
    ];

    const MODELS = {
        repvit: { 
            encUrl: 'repvit_sam_image_encoder.onnx', 
            decUrl: 'repvit_sam_decoder.onnx',
            sessEnc: null, sessDec: null 
        },
        mobile: { 
            encUrl: 'mobile_sam_image_encoder.onnx', 
            decUrl: 'mobile_sam_decoder.onnx',
            sessEnc: null, sessDec: null 
        }
    };

    // --- HELPER: Load Image to Tensor (Pre-processing) ---
    // Mengubah gambar URL menjadi Float32Array [1, 3, 1024, 1024]
    async function imageToTensor(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = url;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 1024;
                canvas.height = 1024;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, 1024, 1024);
                const imageData = ctx.getImageData(0, 0, 1024, 1024);
                const { data } = imageData;
                
                const float32Data = new Float32Array(3 * 1024 * 1024);
                // Normalisasi sederhana & HWC -> CHW
                for (let i = 0; i < 1024 * 1024; i++) {
                    float32Data[i] = data[i * 4] / 255.0; // R
                    float32Data[i + 1024 * 1024] = data[i * 4 + 1] / 255.0; // G
                    float32Data[i + 2 * 1024 * 1024] = data[i * 4 + 2] / 255.0; // B
                }
                const tensor = new ort.Tensor('float32', float32Data, [1, 3, 1024, 1024]);
                resolve(tensor);
            };
            img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
        });
    }

    // --- INITIALIZATION ---
    async function init() {
        const btn = document.getElementById('loadBtn');
        const status = document.getElementById('status');
        btn.disabled = true;

        try {
            const opt = { executionProviders: ['wasm'], graphOptimizationLevel: 'all' };

            status.innerText = "Downloading RepViT Models...";
            MODELS.repvit.sessEnc = await ort.InferenceSession.create(MODELS.repvit.encUrl, opt);
            MODELS.repvit.sessDec = await ort.InferenceSession.create(MODELS.repvit.decUrl, opt);

            status.innerText = "Downloading MobileSAM Models...";
            MODELS.mobile.sessEnc = await ort.InferenceSession.create(MODELS.mobile.encUrl, opt);
            MODELS.mobile.sessDec = await ort.InferenceSession.create(MODELS.mobile.decUrl, opt);

            status.innerText = "‚úÖ Ready! Models Loaded.";
            btn.style.display = 'none';
            document.getElementById('runBtn').style.display = 'block';

        } catch (e) {
            status.innerText = "‚ùå Error: " + e.message;
            console.error(e);
            btn.disabled = false;
        }
    }

    // --- BENCHMARK ENGINE ---
    async function startBenchmark() {
        const btn = document.getElementById('runBtn');
        const status = document.getElementById('status');
        const imgEl = document.getElementById('previewImg');
        const counterEl = document.getElementById('imgCounter');
        const progressEl = document.getElementById('progressBar');
        
        btn.disabled = true;
        document.getElementById('resultTable').style.display = 'none';
        document.getElementById('final-score').style.display = 'none';

        let repTotalTime = 0, repEncTime = 0, repDecTime = 0;
        let mobTotalTime = 0, mobEncTime = 0, mobDecTime = 0;

        try {
            // LOOP 6 GAMBAR
            for (let i = 0; i < IMAGES.length; i++) {
                const imgUrl = IMAGES[i];
                const displayIndex = i + 1;
                
                // Update UI
                imgEl.src = imgUrl;
                counterEl.innerText = `Image ${displayIndex}/6`;
                progressEl.style.width = `${(i / IMAGES.length) * 100}%`;
                status.innerText = `Processing Image ${displayIndex}...`;
                
                // Jeda agar UI merender gambar baru
                await new Promise(r => setTimeout(r, 100));

                // 1. Preprocess (Tidak dihitung dalam waktu inferensi)
                const tensor = await imageToTensor(imgUrl);

                // 2. Run RepViT
                const tRep = await runInference(MODELS.repvit, tensor);
                repEncTime += tRep.enc;
                repDecTime += tRep.dec;
                repTotalTime += tRep.total;

                // 3. Run MobileSAM
                const tMob = await runInference(MODELS.mobile, tensor);
                mobEncTime += tMob.enc;
                mobDecTime += tMob.dec;
                mobTotalTime += tMob.total;
            }

            progressEl.style.width = "100%";
            status.innerText = "üèÅ Benchmark Complete!";
            
            // CALCULATE AVERAGES
            const count = IMAGES.length;
            displayResults(
                { enc: repEncTime/count, dec: repDecTime/count, total: repTotalTime/count },
                { enc: mobEncTime/count, dec: mobDecTime/count, total: mobTotalTime/count }
            );

        } catch (e) {
            status.innerText = "‚ùå Error during benchmark: " + e.message;
            console.error(e);
        }
        btn.disabled = false;
    }

    async function runInference(model, imageTensor) {
        // --- Encoder ---
        const startEnc = performance.now();
        const resEnc = await model.sessEnc.run({ 'image': imageTensor });
        const embeddings = resEnc[Object.keys(resEnc)[0]];
        const endEnc = performance.now();

        // --- Decoder Inputs (Dummy Point Center) ---
        const pointCoords = new ort.Tensor('float32', new Float32Array([512, 512, 0, 0]), [1, 2, 2]);
        const pointLabels = new ort.Tensor('float32', new Float32Array([1, -1]), [1, 2]);
        const maskInput = new ort.Tensor('float32', new Float32Array(256 * 256).fill(0), [1, 1, 256, 256]);
        const hasMask = new ort.Tensor('float32', new Float32Array([0]), [1]);
        const origSize = new ort.Tensor('float32', new Float32Array([1024, 1024]), [2]);

        const feedsDec = {
            'image_embeddings': embeddings,
            'point_coords': pointCoords,
            'point_labels': pointLabels,
            'mask_input': maskInput,
            'has_mask_input': hasMask,
            'orig_im_size': origSize
        };

        // --- Decoder ---
        const startDec = performance.now();
        await model.sessDec.run(feedsDec);
        const endDec = performance.now();

        return {
            enc: endEnc - startEnc,
            dec: endDec - startDec,
            total: (endEnc - startEnc) + (endDec - startDec)
        };
    }

    function displayResults(repAvg, mobAvg) {
        // Fill Table
        document.getElementById('rep-enc').innerText = repAvg.enc.toFixed(1) + " ms";
        document.getElementById('rep-dec').innerText = repAvg.dec.toFixed(1) + " ms";
        document.getElementById('rep-total').innerText = repAvg.total.toFixed(1) + " ms";

        document.getElementById('mob-enc').innerText = mobAvg.enc.toFixed(1) + " ms";
        document.getElementById('mob-dec').innerText = mobAvg.dec.toFixed(1) + " ms";
        document.getElementById('mob-total').innerText = mobAvg.total.toFixed(1) + " ms";

        // Determine Winner
        const repRow = document.getElementById('row-repvit');
        const mobRow = document.getElementById('row-mobile');
        const scoreDiv = document.getElementById('final-score');
        
        document.getElementById('resultTable').style.display = 'table';
        scoreDiv.style.display = 'block';

        if (repAvg.total < mobAvg.total) {
            repRow.className = "winner";
            mobRow.className = "loser";
            const speedup = mobAvg.total / repAvg.total;
            scoreDiv.innerText = `üèÜ RepViT is ${speedup.toFixed(2)}x Faster on Average!`;
            scoreDiv.style.color = "#155724";
            scoreDiv.style.background = "#d4edda";
        } else {
            mobRow.className = "winner";
            repRow.className = "loser";
            const speedup = repAvg.total / mobAvg.total;
            scoreDiv.innerText = `üêå RepViT is ${speedup.toFixed(2)}x Slower than MobileSAM.`;
            scoreDiv.style.color = "#721c24";
            scoreDiv.style.background = "#f8d7da";
        }
    }
</script>

</body>
</html>