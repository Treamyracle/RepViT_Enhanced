<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RepViT-SAM On-Device Benchmark</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 20px; background: #f0f0f0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; margin-top: 20px; width: 100%; }
        button:disabled { background: #ccc; }
        #status { margin-top: 20px; font-weight: bold; color: #333; }
        #results { margin-top: 20px; text-align: left; background: #eee; padding: 15px; border-radius: 8px; display: none;}
        img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h1>üì± On-Device Benchmark</h1>
    <p>This runs 100% on your phone's hardware (CPU/GPU via WebAssembly).</p>
    
    <img id="testImage" src="app/assets/picture1.jpg" alt="Test Image">
    
    <div id="status">Status: Waiting to load models...</div>
    <button id="runBtn" onclick="runBenchmark()" disabled>Load Models First</button>
    
    <div id="results"></div>
</div>

<script>
    let sessionEncoder = null;
    let sessionDecoder = null;
    
    // Konfigurasi Path File ONNX (Pastikan nama file sesuai dengan yang Anda export)
    const ENCODER_PATH = 'repvit_sam_image_encoder.onnx';
    const DECODER_PATH = 'repvit_sam_decoder.onnx';

    async function loadModels() {
        document.getElementById('status').innerText = "‚è≥ Downloading & Compiling Models to Browser...";
        try {
            // Setup Session Options (Menggunakan WASM)
            const option = { executionProviders: ['wasm'], graphOptimizationLevel: 'all' };
            
            // Load Encoder (Bagian Terberat)
            sessionEncoder = await ort.InferenceSession.create(ENCODER_PATH, option);
            
            // Load Decoder
            sessionDecoder = await ort.InferenceSession.create(DECODER_PATH, option);

            document.getElementById('status').innerText = "‚úÖ Models Loaded! Ready to Test.";
            document.getElementById('runBtn').innerText = "üî• Start Benchmark (RepViT)";
            document.getElementById('runBtn').disabled = false;
        } catch (e) {
            document.getElementById('status').innerText = "‚ùå Error Loading Models: " + e.message;
            console.error(e);
        }
    }

    async function runBenchmark() {
        document.getElementById('runBtn').disabled = true;
        document.getElementById('status').innerText = "üöÄ Running Inference... Please wait.";
        document.getElementById('results').style.display = 'none';

        try {
            // 1. Preprocess Image (Simulasi input dummy untuk benchmark kecepatan murni)
            // RepViT input size biasanya 1024x1024x3
            const inputTensor = new ort.Tensor('float32', new Float32Array(1 * 3 * 1024 * 1024).fill(0.5), [1, 3, 1024, 1024]);
            
            // --- BENCHMARK ENCODER ---
            const startEnc = performance.now();
            
            // Jalankan Encoder
            const feedsEnc = { 'image': inputTensor }; // Sesuaikan nama input layer jika berbeda (misal 'input')
            const resultsEnc = await sessionEncoder.run(feedsEnc);
            const imageEmbeddings = resultsEnc[Object.keys(resultsEnc)[0]]; // Ambil output pertama
            
            const endEnc = performance.now();
            const timeEnc = endEnc - startEnc;

            // --- BENCHMARK DECODER ---
            // Siapkan dummy inputs untuk decoder (Prompt titik tengah)
            const pointCoords = new ort.Tensor('float32', new Float32Array([512, 512, 0, 0]), [1, 2, 2]); // Contoh 2 point
            const pointLabels = new ort.Tensor('float32', new Float32Array([1, -1]), [1, 2]);
            const maskInput = new ort.Tensor('float32', new Float32Array(256 * 256).fill(0), [1, 1, 256, 256]); // Dummy mask
            const hasMask = new ort.Tensor('float32', new Float32Array([0]), [1]);
            const origSize = new ort.Tensor('float32', new Float32Array([1024, 1024]), [2]);

            const feedsDec = {
                'image_embeddings': imageEmbeddings,
                'point_coords': pointCoords,
                'point_labels': pointLabels,
                'mask_input': maskInput,
                'has_mask_input': hasMask,
                'orig_im_size': origSize
            };

            const startDec = performance.now();
            await sessionDecoder.run(feedsDec);
            const endDec = performance.now();
            const timeDec = endDec - startDec;

            // Tampilkan Hasil
            const totalTime = timeEnc + timeDec;
            const log = `
                <h3>üìä Benchmark Results</h3>
                <p><strong>Device:</strong> Your Browser (Client-Side)</p>
                <hr>
                <p><strong>Image Encoder:</strong> ${timeEnc.toFixed(2)} ms</p>
                <p><strong>Mask Decoder:</strong> ${timeDec.toFixed(2)} ms</p>
                <p style="font-size: 1.2em; font-weight: bold;">Total Latency: ${totalTime.toFixed(2)} ms</p>
            `;
            
            document.getElementById('results').innerHTML = log;
            document.getElementById('results').style.display = 'block';
            document.getElementById('status').innerText = "‚úÖ Done!";

        } catch (e) {
            document.getElementById('status').innerText = "‚ùå Error during inference: " + e.message;
            console.error(e);
        }
        
        document.getElementById('runBtn').disabled = false;
    }

    // Load models saat halaman dibuka
    window.onload = loadModels;
</script>

</body>
</html>